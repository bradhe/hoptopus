<% content_for :title do %>
	<% if is_users_cellar? %>
		your beer cellar
	<% else %>
		<%= @cellar.user.username %>'s beer cellar
	<% end %>
<% end %>

<% if is_users_cellar? %>
	<div class="info">
		This is your cellar! Share it with others: <a href="<%= cellar_url %>"><%= cellar_url %></a> 
	</div>
	
	<% if notice %>
		<div class="notice"><%= notice %></div>
	<% end %>
<% end %>

<h2 data-tab-handle="cellar">
	<% unless is_users_cellar? %>
		<%= @cellar.user.username %>'s
	<% end %>
	
	Cellar
</h2>

<div id="cellar">
    <h3>Currently in Cellar</h3>
	<table class="list" <%= is_table_sortable? @cellar.beers.select { |b| b.removed_at.nil? } %>>
		<thead>
			<tr>
				<th width="40"></th>
				<th>Brewery</th>
				<th>Beer</th>
				<th>Size</th>
				<th>Quantity</th>
				<th>Cellared</th>
				<th class="unsortable"></th>
			<% if is_users_cellar? %>
				<th class="unsortable"></th>
				<th class="unsortable"></th>
				<th class="unsortable"></th>
			<% end %>
			</tr>
		</thead>
		
		<tbody>
		
	<% if @cellar.beers.select { |b| b.removed_at.nil? }.empty? %>
	
			<tr>
				<td colspan="<%= is_users_cellar? ? '8' : '7' %>" class="empty">Hmm doesn't look like you have any beers in your cellar.</td>
			</tr>
			
	<% else %>
	
		<% c = 'color2' %>
		<% @cellar.beers.select { |b| b.removed_at.nil? }.each do |b| %>
			<% c = (c == 'color2' ? 'color1' : 'color2') %>
			
			<tr data-beer-id="<%= b.id %>" class="<%= c %>">
				<td align="right" class="year"><%= b.year %></td>
				<td><%= b.brewery_name || b.brew.brewery.name %></td>
				<td data-brew-id="<%= b.brew.id %>"><%= link_to b.name, brew_path(b.brew) %></td>
				<td align="center"><%= b.bottle_size.name %></td>
				<td class="quantity" align="center"><%= b.quantity %></td>
				<td align="center" data-cellared-at="<%= b.cellared_at %>"><%= b.cellared_at.nil? ? 'Unknown' : distance_of_time_in_words(b.cellared_at, Time.now) + ' ago' %></td>
				<td align="center"><%= link_to 'Notes', cellar_beer_path(@cellar, b) %></td>
				
			<% if is_users_cellar? %>
			
				<td align="center"><%= link_to 'Tasted', new_cellar_beer_tasting_path(@cellar, b) %></td>
				<td align="center"><%= link_to 'Edit Beer', edit_cellar_beer_path(@cellar, b) %></td>
				<td align="center"><%= button_to 'Remove', cellar_beer_path(@cellar, b), :method => :delete, :confirm => 'Removes beer from cellar and places in cellar history. You sure you wanna do that?' %></td>
				
			<% end %>
			
			</tr>
			
		<% end %>
		
	<% end %>
		</tbody>
	</table>
    
    <h3>Recent Activity</h3>
    <ul class="events">
    <% if @cellar.user.events.empty? %>
        <li class="empty"><%= is_users_cellar? ? "You haven't": @cellar.user.username + " hasn't"%> done anything recently.</li>
    <% else %>
        <% @cellar.user.events.each do |e| %>
            <%== render_event e  %>
        <% end %>
    <% end %>
    </ul>
</div>

<h2 data-tab-handle="cellar-history">Cellar History</h2>
<div id="cellar-history">
	<table class="list" <%= is_table_sortable? @cellar.beers.select { |b| not b.removed_at.nil? } %>>
		<thead>
			<tr>
				<th width="40"></th>
				<th>Brewery</th>
				<th>Beer</th>
				<th>Size</th>
				<th>Quantity</th>
				<th>Cellared</th>
				<th>Removed On</th>
				<th class="unsortable"></th>
			<% if is_users_cellar? %>
				<th class="unsortable"></th>
			<% end %>
			</tr>
		</thead>
		
		<tbody>
		
	<% if @cellar.beers.select { |b| not b.removed_at.nil? }.empty? %>
	
			<tr>
				<td colspan="<%= is_users_cellar? ? '10' : '9' %>" class="empty">Hmm looks like no beers have been removed from the cellar yet!</td>
			</tr>
			
	<% else %>
	
		<% c = 'color2' %>
		<% @cellar.beers.select { |b| not b.removed_at.nil? }.each do |b| %>
			<% c = (c == 'color2' ? 'color1' : 'color2') %>
			
			<tr data-beer-id="<%= b.id %>" class="<%= c %>">
				<td align="right" class="year"><%= b.year %></td>
				<td><%= b.brewery_name || b.brew.brewery.name %></td>
				<td data-brew-id="<%= b.brew.id %>"><%= link_to b.name, brew_path(b.brew) %></td>
				<td align="center"><%= b.bottle_size.name %></td>
				<td class="quantity" align="center"><%= b.quantity %></td>
				<td align="center" data-cellared-at="<%= b.cellared_at %>"><%= b.cellared_at.nil? ? 'Unknown' : distance_of_time_in_words(b.cellared_at, Time.now) + ' ago' %></td>
				<td align="center"><%= b.removed_at.strftime "%A %B %d, %Y" %></td>
				<td align="center"><%= link_to 'Notes', cellar_beer_path(@cellar, b) %></td>
				
			<% if is_users_cellar? %>
				<td align="center"><%= link_to 'Edit Notes', edit_cellar_beer_path(@cellar, b) %></td>
			<% end %>
			
			</tr>
			
		<% end %>
		
	<% end %>
		</tbody>
	</table>
</div>

<h2 data-tab-handle="tastings">Recent Tastings</h2>
<div id="tastings">

	<table class="list" <%= is_table_sortable? @tastings %>>
		<thead>
			<tr>
				<th>Brewery</th>
				<th>Beer</th>
				<th>Tasted</th>
				<th>Aged</th>
				<th class="unsortable"></th>
			<% if is_users_cellar? %>
				<th class="unsortable"></th>
				<th class="unsortable"></th>
			<% end %>
			</tr>
		</thead>
		
		<tbody>
	<% if @tastings.empty? %>
			<tr>
				<td colspan="3" class="empty">No tastings have been recorded. How sad.</td>
			</tr>
	<% else %>
		<% c = 'color2' %>
		<% @tastings.each do |t| %>
			<% c = (c == 'color2' ? 'color1' : 'color2') %>
			
			<tr class="<%= c %>">
				<td><%= t.brew.brewery.name %></td>
				<td><%= t.brew.name %></td>
				<td align="center"><%= distance_of_time_in_words(t.created_at, Time.now) %> ago</td>
				<td align="center"><%= distance_of_time_in_words(t.cellared_at, t.created_at) %></td>
				<td align="center"><%= link_to 'Notes', brew_tasting_path(t.brew, t) %></td>
			<% if is_users_cellar? %>
				<td align="center"><%= link_to 'Edit Notes', edit_brew_tasting_path(t.brew, t) %></td>
				<td align="center"><%= button_to 'Delete', brew_tasting_path(t.brew, t), :method => :delete, :confirm => 'You sure?' %></td>
		<% end %>
			</tr>
		<% end %>
		</tbody>
	<% end %>
	</table>
	
</div>


<% if is_users_cellar? %>
<h2 data-tab-handle="add-a-beer">Add Beer to your Cellar</h2>
<div id="add-a-beer">
	<% form_for(@new_beer, :url => cellar_beers_path(@cellar)) do |f| %>
	
	<div class="info">Don't see the brewery or beer you need? <%= link_to 'Add a Brewery', new_brewery_path %> <%= link_to 'Add a Beer', new_brew_path %></div>
	
	<div class="field">	
		<%= label_tag "brewery", "Beer:" %>
		<%= select_tag "brewery", options_from_collection_for_select(Brewery.order('name').all, 'id', 'name', (@new_beer.brew ? @new_beer.brew.brewery.id : 0)), { :include_blank => 'Brewery' } %>
		
		<% if @new_beer.brew %>
			<%= f.collection_select :brew_id, Brew.where(:brewery_id => @new_beer.brew.brewery.id).all, :id, :name %>
		<% else %>
			<%= f.select :brew_id, [], { :include_blank => 'Beer' }, :disabled => true %>
		<% end %>
	</div>
	
	<div class="field">
		<%= f.label :year, "Year:" %>
		<%= f.text_field :year, :value => Date.today.year %>
	</div>

	<div class="field">
		<%= f.label :quantity, "Quantity:" %>
		<%= f.text_field :quantity %>
	</div>

	<div class="field">
		<%= f.label :abv, "ABV:" %>
		<%= f.text_field :abv %>
	</div>

	<div class="field">
		<%= f.label :bottle_size_id, "Bottle Size:" %>
		<%= f.collection_select :bottle_size_id, BottleSize.order('order').all, :id, :name %>
	</div>

	<div class="field">
		<%= f.label :price, "Price:" %>
		<%= f.text_field :price %>
	</div>

	<div class="field">
		<%= f.label :cellared_at, "Cellared Date:" %>
		<%= f.text_field :cellared_at, :value => Date.today.to_s %>
	</div>
	
	<div class="field">
		<%= f.label :markup, "Notes:" %>
		<%= f.text_area :markup, :class => 'notes' %>
	</div>

	<div class="buttons">
		<button type="submit" id="add-beer" <%= "disabled" unless not @new_beer.nil? %>>Add Beer to Cellar</button>
	</div>
	
	<% end %>
</div>

<h2 data-tab-handle="update-preferences">Preferences</h2>
<div id="update-preferences">
	<%= form_for(@user) do |f| %>
	<div class="field">
		<%= f.check_box :should_show_own_events %>
		<%= f.label :should_show_own_events, "Show me my events in the recent events section.", :class => 'checkbox-label' %>
	</div>	
	
	<div class="field">
		<%= f.check_box :email_consent %>
		<%= f.label :email_consent, "Is it cool by you if hoptopus emails you from time to time for updates and feedback?", :class => 'checkbox-label' %>
	</div>	
	
	<div class="field">
		<%= f.check_box :should_receive_email_notifications %>
		<%= f.label :should_receive_email_notifications, "Receive notifications about comments and stuff via email?", :class => 'checkbox-label' %>
	</div>	
	
	
	<h3>Location</h3>	
	<% Carmen.excluded_states = { 'US' => ['AE'] } %>
	<div class="field">
		<%= f.label :country, 'Country:' %>
		<%= f.select :country, countries_list %>
	</div>
	
	<div class="field">
		<%= f.label :state, 'State/Province:' %>
		
		<% unless @user.state.nil? %>
			<%= f.select :state, Carmen.states %>
		<% else %>
			<%= f.select :state, [], { :include_blank => 'No states available for this country.' }, :disabled => true %>
		<% end %>
	</div>
	
	<div class="field">
		<%= f.label :city, 'City:' %>
		<%= f.text_field :city %>
	</div>
	
	<div class="buttons">
		<button type="submit" id="save-preferences">Save Preferences</button>
	</div>
	<% end %>
</div>

<% content_for :javascript do %>
<script type="text/javascript">
var brews = {};
<% Brewery.all.each do |b| %>
brews[<%= b.id %>] = <%== b.brews.to_json %>;
<% end %>
</script>
<script src="/javascripts/brewery-helper.js" type="text/javascript"></script>

<script type="text/javascript">
var states = {};
states['US'] = <%== Carmen.states.to_json %>;

$('select#user_country').live('change', function() {
	var statesSelect = $('select#user_state');
	var countryStates = states[$(this).val()];
	
	if(!countryStates && (typeof statesSelect.attr('disabled') !== 'undefined')) {
		statesSelect.empty();
		statesSelect.append($('<option/>').val('').text('No states available for this country.'));
		statesSelect.attr('disabled', true);
		
		return;
	}
	else if(!countryStates && (typeof statesSelect.attr('disabled') === 'undefined')) {
		// Don't do anything
		return;
	}
	
	statesSelect.empty();
	for(var i in countryStates) {
		var state = countryStates[i];
		
		if(typeof(state) != 'object') {
			continue;
		}
		
		statesSelect.append($('<option/>').val(state[1]).text(state[0]));
	}
	
	statesSelect.removeAttr('disabled');
});
</script>

<% end %>
<% end %>

<h3>Comments</h3>
<div id="comments">
    <% unless @cellar.comments.empty? %>
        <% @cellar.comments.each do |c| %>
    <div class="comment">
        <span class="byline"><%= link_to c.user.username, cellar_path(c.user.username) %> (<%= c.created_at.strftime "%A %B %d, %Y" %>)</span>
        <%== m c.comment %>
    </div>
        <% end %>
    <% else %>
    <div class="empty">No comments have been left yet!</div>
    <% end %>
    
    <% if is_logged_in? %>
        <% form_for(@cellar.comments.new, :url => cellar_comments_path(@cellar)) do |f| %>
    <div class="field">
        <%= f.label :comment, 'Leave a comment:' %>
        <%= f.text_area :comment %>
    </div>
    
    <div class="buttons">
        <button type="submit" class="leave-comment" data-comment-box="comment_comment">Leave Comment</button>
    </div>
        <% end %>
    <% end %>
</div>