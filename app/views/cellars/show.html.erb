<% content_for :title do %>
	<% if is_users_cellar? %>
		your beer cellar
	<% else %>
		<%= @cellar.user.username %>'s beer cellar
	<% end %>
<% end %>

<% if is_users_cellar? %>
	<div class="info">
		This is your cellar! Share it with others: <a href="<%= cellar_url %>"><%= cellar_url %></a> 
	</div>
<% end %>

<h2>Cellar Contents</h2>

<p id="notice"><%= notice %></p>

<table class="list">
	<thead>
		<tr>
			<th width="40"></th>
			<th>Brewery</th>
			<th>Beer</th>
			<th>ABV</th>
			<th>Size</th>
			<th>Quantity</th>
			<th>Cellared</th>
		<% if is_users_cellar? %>
			<th></th>
			<th></th>
			<th></th>
		<% end %>
		</tr>
	</thead>
	
	<tbody>
<% if @cellar.beers.empty? %>
		<tr>
			<td colspan="<%= is_users_cellar? ? '8' : '7' %>" class="empty">Hmm doesn't look like you have any beers in your cellar.</td>
		</tr>
<% else %>
	<% c = 'color2' %>
	<% @cellar.beers.each do |b| %>
		<% c = (c == 'color2' ? 'color1' : 'color2') %>
		
		<tr data-beer-id="<%= b.id %>" class="<%= c %>">
			<td align="right" class="year"><%= b.year %></td>
			<td><%= b.brew.brewery.name %></td>
			<td data-brew-id="<%= b.brew.id %>"><%= link_to b.brew.name, brew_path(b.brew) %></td>
			<td align="center"><%= b.abv %></td>
			<td align="center"><%= b.bottle_size.name %></td>
			<td class="quantity" align="center"><%= b.quantity %></td>
			<td align="center" data-cellared-at="<%= b.cellared_at %>"><%= b.cellared_at.nil? ? 'Unknown' : distance_of_time_in_words(b.cellared_at, Time.now) + ' ago' %></td>
		<% if is_users_cellar? %>
			<td align="center"><a href="javascript:void(0);" class="one">Tasted!</a></td>
			<td align="center"><%= link_to 'Edit Beer', edit_cellar_beer_path(@cellar, b) %></td>
			<td align="center"><%= button_to 'Delete', cellar_beer_path(@cellar, b), :method => :delete, :confirm => 'You sure?' %></td>
		<% end %>
		</tr>
	<% end %>
<% end %>
	</tbody>
</table>


<h2 class="tastings">Recent Tastings</h2>

<table class="list">
	<tr>
		<th>Brewery</th>
		<th>Beer</th>
		<th>Tasted</th>
		<th>Aged</th>
		<th></th>
	<% if is_users_cellar? %>
		<th></th>
		<th></th>
	<% end %>
	</tr>
<% if @tastings.empty? %>
	<tr>
		<td colspan="3" class="empty">No tastings have been recorded. How sad.</td>
	</tr>
<% else %>
	<% c = 'color2' %>
	<% @tastings.each do |t| %>
		<% c = (c == 'color2' ? 'color1' : 'color2') %>
		
	<tr class="<%= c %>">
		<td><%= t.brew.brewery.name %></td>
		<td><%= t.brew.name %></td>
		<td align="center"><%= distance_of_time_in_words(t.created_at, Time.now) %> ago</td>
		<td align="center"><%= distance_of_time_in_words(t.cellared_at, t.created_at) %></td>
		<td align="center"><%= link_to 'View Notes', brew_tasting_path(t.brew, t) %></td>
	<% if is_users_cellar? %>
		<td align="center"><%= link_to 'Edit Notes', edit_brew_tasting_path(t.brew, t) %></td>
		<td align="center"><%= button_to 'Delete', brew_tasting_path(t.brew, t), :method => :delete %></td>
	<% end %>
	</tr>
	<% end %>
<% end %>
</table>

<% if is_users_cellar? %>
	<h3 data-hideable="add-beer-form">Add a Beer to your Cellar</h3>
	<div id="add-beer-form">
		<% form_for(@cellar.beers.new, :url => cellar_beers_path(@cellar)) do |f| %>
		
		<div class="info">Don't see the brewery or beer you need? <%= link_to 'Add a Brewery', new_brewery_path %> <%= link_to 'Add a Beer', new_brew_path %></div>
		
		<div class="field">	
			<%= label_tag "brewery", "Beer:" %>
			<%= select_tag "brewery", options_from_collection_for_select(Brewery.all, 'id', 'name'), { :include_blank => 'Brewery' } %>
			<%= f.select :brew_id, [], { :include_blank => 'Beer' }, :disabled => true %>
		</div>
		
		<div class="field">
			<%= f.label :year, "Year:" %>
			<%= f.text_field :year, :value => Date.today.year %>
		</div>

		<div class="field">
			<%= f.label :quantity, "Quantity:" %>
			<%= f.text_field :quantity %>
		</div>

		<div class="field">
			<%= f.label :abv, "ABV:" %>
			<%= f.text_field :abv %>
		</div>

		<div class="field">
			<%= f.label :bottle_size_id, "Bottle Size:" %>
			<%= f.collection_select :bottle_size_id, BottleSize.all, :id, :name %>
		</div>

		<div class="field">
			<%= f.label :price, "Price:" %>
			<%= f.text_field :price %>
		</div>

		<div class="field">
			<%= f.label :cellared_at, "Cellared Date:" %>
			<%= f.text_field :cellared_at, :value => Date.today.to_s %>
		</div>

		<div class="buttons">
			<button type="submit" id="add-beer" disabled>Add Beer to Cellar</button>
		</div>
	</div>

<% content_for :javascript do %>
<script type="text/javascript">
var brews = {};
<% Brewery.all.each do |b| %>
brews[<%= b.id %>] = <%== b.brews.to_json %>;
<% end %>

$('a.one').live('click', function() {
	// Force the browser to post over to the other page
	var brewId = $(this).parent().siblings('td[data-brew-id]').attr('data-brew-id');
	var cellaredAt = $(this).parent().siblings('td[data-cellared-at]').attr('data-cellared-at');
	var year = $(this).parent().siblings('td.year').text();

	var quantity = parseInt($(this).parent().siblings('td.quantity').text());
	
	var url = '/brews/'+brewId+'/tastings.json';
	
	var data = { 
		'authenticity_token': $('meta[name="csrf-token"]').attr('content'),
		'tasting': {
			'cellared_at': cellaredAt,
			'brew_id': brewId,
			'user_id': <%= @cellar.user.id %>,
			'year': year
		}
	};
	
	$.ajax({
		url: url,
		type: 'POST',
		data: data,
		success: function(data) {
			window.location.reload();
		},
		error: function() {
			alert('failwhale');
		}
	});
});
</script>

<script src="/javascripts/brewery-helper.js" type="text/javascript"></script>

<% end %>

	<% end %>
<% end %>