<% content_for :title do %>
	<% if is_users_cellar? %>
		your beer cellar
	<% else %>
		<%= @cellar.user.username %>'s beer cellar
	<% end %>
<% end %>

<h2>What's in the Cellar?</h2>
<% if is_users_cellar? %>
	<div class="users-cellar info">
		This is your cellar! Share it with others: <a href="<%= cellar_url %>"><%= cellar_url %></a> 
	</div>
<% end %>

<p id="notice"><%= notice %></p>

<table class="list">
	<thead>
		<tr>
			<th></th>
			<th>Brewery</th>
			<th>Beer</th>
			<th>ABV</th>
			<th>Size</th>
			<th>Quantity</th>
			<th>Cellared</th>
		<% if is_users_cellar? %>
			<th></th>
			<th></th>
		<% end %>
		</tr>
	</thead>
	
	<tbody>
<% if @cellar.beers.empty? %>
		<tr>
			<td colspan="6" class="empty">Hmm doesn't look like you have any beers in your cellar.</td>
		</tr>
<% else %>
	<% @cellar.beers.each do |b| %>
		<tr data-beer-id="<%= b.id %>">
			<th><%= b.year %></th>
			<td><%= b.brew.brewery.name %></td>
			<td><%= b.brew.name %></td>
			<td><%= b.abv %></td>
			<td><%= b.size %></td>
			<td class="quantity"><%= b.quantity %></td>
			<td><%= b.cellared_at.nil? ? 'Unknown' : distance_of_time_in_words(b.cellared_at, Time.now) %></td>
		<% if is_users_cellar? %>
			<td><a href="javascript:void(0);" class="one">Drank one!</a></td>
			<td><a href="javascript:void(0);" class="all">Drank all!</a></td>
		<% end %>
		</tr>
	<% end %>
<% end %>
	</tbody>
</table>

<% unless @cellar.user != @user %>
	<h3 data-hideable="true">Add a Beer to your Cellar</h3>

	<% form_for(@cellar.beers.new, :url => cellar_beers_path(@cellar)) do |f| %>
	
	<div class="field">	
		<%= label_tag "brewery", "Beer:" %>
		<%= select_tag "brewery", options_from_collection_for_select(Brewery.all, 'id', 'name'), { :include_blank => '' } %>
		<%= f.select :brew_id, [], { :include_blank => 'Select a Brewery' }, :disabled => true %>
		
		<span class="note">Don't see the brewery or beer you want? <%= link_to 'Add a Brewery', new_brewery_path %> <%= link_to 'Add a Beer', new_brew_path %> 
	</div>
	
	<div class="field">
		<%= f.label :year, "Year:" %>
		<%= f.text_field :year, :value => Date.today.year %>
	</div>

	<div class="field">
		<%= f.label :quantity, "Quantity:" %>
		<%= f.text_field :quantity %>
	</div>

	<div class="field">
		<%= f.label :abv, "ABV:" %>
		<%= f.text_field :abv %>
	</div>

	<div class="field">
		<%= f.label :size, "Bottle Size:" %>
		<%= f.text_field :size %>
	</div>

	<div class="field">
		<%= f.label :price, "Price:" %>
		<%= f.text_field :price %>
	</div>

	<div class="field">
		<%= f.label :cellared_at, "Cellared Date:" %>
		<%= f.text_field :cellared_at, :value => Date.today.to_s %>
	</div>

	<div class="buttons">
		<button type="submit" id="add-beer" disabled>Add Beer to Cellar</button>
	</div>

<% content_for :javascript do %>
<script type="text/javascript">
var brews = {};
<% Brewery.all.each do |b| %>
brews[<%= b.id %>] = <%== b.brews.to_json %>;
<% end %>

$('select#brewery').live('change', function() {
	var selectBrews = $('select#beer_brew_id');
	var button = $('#add-beer');
	
	if(!selectBrews) {
		throw "Couldn't find brews list. Ass.";
	}
	
	if($(this).val() == '') {
		// TODO: Add more stuff here. Disable selectBrews, add first element, etc.
		selectBrews.empty();
		selectBrews.attr('disabled', true);
		button.attr('disabled', true);
		selectBrews.append($('<option/>').val('').text('Select a Brewery'));
		
		return;
	}
	
	var breweryBrews = brews[$(this).val()];
	if(!breweryBrews) {
		throw "No brews for this brewery.";
	}
	
	// Populate the other drop down
	selectBrews.empty();
	
	// If this brewery doesn't have any brews then...boned.
	if (breweryBrews.length < 1) {
		selectBrews.attr('disabled', true);
		button.attr('disabled', true);
		selectBrews.append($('<option/>').val('').text('No beers in the wiki for this brewery.'));
		
		return;
	}	
	else {
		selectBrews.removeAttr('disabled');
		
		// Set up this thing so the button gets disabled.
		selectBrews.change(function() {
			if($(this).val() != '') {
				button.removeAttr('disabled');
			}
			else {
				button.attr('disabled', true);
			}
		});
	}
	
	selectBrews.append($('<option/>').val('').text('Select a Beer'));
	
	for(var i in breweryBrews) {
		var brew = breweryBrews[i];
		
		if(typeof(brew) != 'object') {
			continue;
		}
		
		selectBrews.append($('<option/>').val(brew.brew.id).text(brew.brew.name));
	}
});

$('a.one').live('click', function() {
	// Force the browser to post over to the other page
	var beerId = $(this).parents('tr[data-beer-id]').attr('data-beer-id');
	var quantity = parseInt($(this).parent().siblings('td.quantity').text());
	
	var form = $('<form/>').attr('action', '/cellars/<%= @cellar.id %>/beers/' + beerId).attr('method', 'post');
	form.append($('<input/>').attr('name', 'authenticity_token').val($('meta[name="csrf-token"]').attr('content')));
	form.append($('<input/>').attr('name', '_method').val('put'));
	form.append($('<input/>').attr('name', 'beer[quantity]').val(quantity - 1));
	form.submit();
});
</script>
<% end %>

	<% end %>
<% end %>

<h2>Recent Tastings</h2>

<table class="list">
	<tr>
		<th>Brewery</th>
		<th>Beer</th>
		<th>Tasted</th>
		<th>Aged</th>
	</tr>
<% if @tastings.empty? %>
	<tr>
		<td colspan="3" class="empty">No tastings have been recorded. How sad.</td>
	</tr>
<% else %>
	<% @tastings.each do |t| %>
	<tr>
		<td><%= t.beer.brew.brewery.name %></td>
		<td><%= t.beer.brew.name %></td>
		<td><%= distance_of_time_in_words(t.created_at, Time.now) %> ago</td>
		<td><%= distance_of_time_in_words(t.beer.cellared_at, t.created_at) %></td>
	</tr>
	<% end %>
<% end %>
</table>